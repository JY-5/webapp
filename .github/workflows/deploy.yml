name: webapp CI

on:
  workflow_dispatch: 
  push:
    branches: [ main ]

env:
  artifact_name: webapp.tar
  s3_bucket_name: webapp.jing.yang

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
        aws-region: us-east-1

    - name: upload to s3
      run: |
        mkdir webapp_s3
        cp ./*.js webapp_s3
        cp -r ./models webapp_s3
        cp -r ./routes webapp_s3
        cp -r ./services webapp_s3
        echo "tar webapp.tar start"
        tar -cvf webapp.tar webapp_s3
        echo "tar webapp.tar complete"
        echo "aws s3 upload start"
        aws s3 cp webapp.tar s3://${s3_bucket_name}
        echo "aws s3 upload complete"

    - name: deploy
      run: |
          output=$(aws deploy create-deployment \
          --application-name webapp \
          --deployment-config-name CodeDeployDefault.AllAtOnce \
          --deployment-group-name webapp-group \
          --description "CodeDeploy" \
          --s3-location bucket=${{ secrets.S3_BUCKET_NAME }},key=webapp.tar,bundleType=tar \
          --region us-east-1 \
          --output json)
          echo $output
          dId=$(echo $output | jq -r '.deploymentId')
          aws deploy wait deployment-successful --deployment-id $dId